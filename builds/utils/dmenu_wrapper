cachedir="${XDG_CACHE_HOME:-"$HOME/.cache"}"
cache="$cachedir/dmenu_run"

[ ! -e "$cachedir" ] && mkdir -p "$cachedir"

OLD_IFS="$IFS"
IFS=:
if stest -dqr -n "$cache" $PATH; then
	stest -flx $PATH | sort -u > "$cache"
fi
IFS="$OLD_IFS"

extra_choices="fan: turn off
fan: turn on
downstairs: turn off
downstairs: turn on
hallway: turn off
hallway: turn on
bonus room: turn off
bonue room: turn on
scrcpy: default
scrcpy: with audio
phone: open termux
phone: open antennapod
phone: open email
phone: open vlc
phone: open planningcenter
phone: open orgzly
phone: open dialer
phone: open graph89
phone: open cone
phone: open newpipe
phone: open messaging
phone: open syncthing
phone: silent notifications
phone: vibrate notifications
phone: sound notifications
phone: place phone call
phone: compose message
select a wallpaper
i3: enable gaps
i3: disable gaps
i3: rename workspace
hammurabi: desk monitor setup
hammurabi: one screen
syncthing: view logs
second_cmus
bluetooth
volume"

response="$(echo "$extra_choices" | cat - "$cache" | dmenu)"
case "$response" in
    "bluetooth")
	st -c st_floating -e bluetuith
	;;
    "bluetuith")
	st -c st_floating -e bluetuith
	;;
    "cmus")
	st -e cmus
	;;
    "second_cmus")
	st -e bash -c 'CMUS_SOCKET=/run/user/1000/cmus2-socket cmus'
	;;
    "volume")
	st -c st_floating -e ncpamixer
	;;
    "ncpamixer")
	st -c st_floating -e ncpamixer
	;;
    "nmtui")
	st -c st_floating -e nmtui
	;;
    "fan: turn off")
	openhue set light f0258cd9-40bf-486d-ba17-0f3452ed534e --off
	;;
    "fan: turn on")
	openhue set light f0258cd9-40bf-486d-ba17-0f3452ed534e --on
	;;
    "downstairs: turn off")
	openhue set room 34942881-b3be-4065-b604-bf3068cc182e --off
	openhue set room 726deff6-2b56-4010-a714-454d4bc2fb7c --off
	openhue set room bce91c38-adbc-4b6c-9097-1385be01dd64 --off
	;;
    "downstairs: turn on")
	openhue set room 34942881-b3be-4065-b604-bf3068cc182e --on
	openhue set room 726deff6-2b56-4010-a714-454d4bc2fb7c --on
	openhue set room bce91c38-adbc-4b6c-9097-1385be01dd64 --on
	;;
    "hallway: turn off")
	openhue set room 363cfd62-b30d-43a1-b92a-cf24aa3e01de --off
	;;
    "hallway: turn on")
	openhue set room 363cfd62-b30d-43a1-b92a-cf24aa3e01de --on
	;;
    "bonus room: turn off")
	openhue set room 9c8611de-8b22-41cd-81fc-cae3345c51c8 --off
	;;
    "bonus room: turn on")
	openhue set room 9c8611de-8b22-41cd-81fc-cae3345c51c8 --on
	;;
    "scrcpy: default")
	scrcpy --render-driver=opengles2 --no-audio
	;;
    "scrcpy: with audio")
	scrcpy --render-driver=opengles2
	;;
    "phone: open termux")
	adb shell monkey -p com.termux -c android.intent.category.LAUNCHER 1
	;;
    "phone: open antennapod")
	adb shell monkey -p de.danoeh.antennapod -c android.intent.category.LAUNCHER 1
	;;
    "phone: open email")
	adb shell monkey -p eu.faircode.email -c android.intent.category.LAUNCHER 1
	;;
    "phone: open vlc")
	adb shell monkey -p org.videolan.vlc -c android.intent.category.LAUNCHER 1
	;;
    "phone: open planningcenter")
	adb shell monkey -p com.ministrycentered.PlanningCenter -c android.intent.category.LAUNCHER 1
	;;
    "phone: open orgzly")
	adb shell monkey -p com.orgzlyrevived -c android.intent.category.LAUNCHER 1
	;;
    "phone: open dialer")
	adb shell am start -n com.google.android.dialer/com.google.android.dialer.extensions.GoogleDialtactsActivity
	;;
    "phone: open graph89")
	adb shell monkey -p com.eanema.graph89 -c android.intent.category.LAUNCHER 1
	;;
    "phone: open cone")
	adb shell monkey -p info.tangential.cone -c android.intent.category.LAUNCHER 1
	;;
    "phone: open newpipe")
	adb shell monkey -p org.schabi.newpipe -c android.intent.category.LAUNCHER 1
	;;
    "phone: open messaging")
	adb shell monkey -p com.google.android.apps.messaging -c android.intent.category.LAUNCHER 1
	;;
    "phone: open syncthing")
	adb shell monkey -p com.github.catfriend1.syncthingandroid -c android.intent.category.LAUNCHER 1
	;;
    "phone: silent notifications")
	adb shell cmd audio set-ringer-mode SILENT
	;;
    "phone: vibrate notifications")
	adb shell cmd audio set-ringer-mode VIBRATE
	;;
    "phone: sound notifications")
	adb shell cmd audio set-ringer-mode NORMAL
	;;
    "phone: place phone call")
	scrcpy-phone-dialer phone
	;;
    "phone: compose message")
	scrcpy-phone-dialer messaging
	;;
    "select a wallpaper")
	wallpapers=$(ls ~/media/wallpapers)
	choice=$(printf "random\nrandom per monitor\n${wallpapers}" | dmenu)
	case "${choice}" in
	    "random")
		random_monitor=$(ls ~/media/wallpapers/ | shuf | head -n1)
		feh --bg-fill "${HOME}/media/wallpapers/$random_monitor"
	        ;;
	    "random per monitor")
		number_of_monitors=$(xrandr --listmonitors | grep -v "Monitors" | wc -l)
		args=""
		for i in $(seq "$number_of_monitors"); do
		    random_monitor=$(ls ~/media/wallpapers/ | shuf | head -n1)
		    args="$args --bg-fill ${HOME}/media/wallpapers/$random_monitor"
		done
		args="feh$args"
		eval "$args"
	        ;;
	    *)
		feh --bg-fill "${HOME}/media/wallpapers/${choice}"
		;;
	esac
	;;
    "i3: enable gaps")
	i3-msg gaps inner all set 10
	;;
    "i3: disable gaps")
	i3-msg gaps inner all set 0
	;;
    "i3: rename workspace")
	current_workspace=$(i3-msg -t 'get_workspaces' | jq -r '.[] | select(.focused==true).num')
	new_name=$(echo "" | dmenu)
	if [ -z "$new_name" ]; then
	    i3-msg "rename workspace to \"${current_workspace}\""
	else
	    i3-msg "rename workspace to \"${current_workspace}: ${new_name}\""
	fi
	;;
    "hammurabi: desk monitor setup")
	xrandr --output eDP-1 --primary --mode 1920x1080 --pos 653x900 \
	       --output HDMI-1 --mode 1600x900 --pos 1600x0 \
	       --output DP-2 --mode 1600x900 --pos 0x0
	;;
    "hammurabi: one screen")
	xrandr --output eDP-1 --auto --primary \
	       --output HDMI-1 --off \
	       --output DP-2 --off
	;;
    "syncthing: view logs")
	st -c st_floating -e journalctl -xefu syncthing
	;;
    "calc:"*)
	command="${response#*:}"
	session_name="dmenu_wrapper-$RANDOM"
	tmux new-session -d -s "$session_name" 'python3'
	tmux send-keys -t "$session_name" "from math import *" Enter
	tmux send-keys -t "$session_name" "$command" Enter
	st -c st_floating -e tmux attach-session -t "$session_name"
	tmux kill-session -t "$session_name"
	;;
    *)
	if [ -n "$response" ]; then
	    RUNNING_FROM_DMENU=1 "$response"
	fi
	;;
esac
